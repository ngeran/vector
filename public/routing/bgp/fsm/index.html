<!DOCTYPE html>
<html lang="en-us" dir="ltr" class="scroll-smooth">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
<meta name="robots" content="noindex, nofollow" />
<title>
Finite State Machine | ngeran[io]
</title>

    <link rel="stylesheet" href="/css/styles.css">


      <script src="/js/main.js"></script>


</head>
<body class="flex flex-col h-screen px-6 m-auto leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-gray-900 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600">
  <header>
    <div class="fixed inset-x-0 pl-[24px] pr-[24px]" style="z-index:100">
  <nav class="relative max-w-[64rem] ml-auto mr-auto top-3 p-4  lg:px-8  lg:py-3 shadow-lg bg-[#d8dee9] bg-opacity-10 backdrop-blur-lg backdrop-saturate-150 z-50 rounded-2xl  ">
    <div class="mx-auto flex items-center justify-between">
      
      <div class=" text-xl ">
       <a href="/" class="text-xl" ><span class="text-[#eceff4] ">ngeran</span><span class="text-[#81a1c1]">[</span><span class="text-[#ebcb8b]">io</span><span class="text-[#81a1c1]">]</span>
        </a>
      </div>
  
      
      <div class="hidden lg:flex space-x-6 ">
        
          <div class="relative group">
            <a href="/" class=" text-[#d8dee9] hover:text-[#ebcb8b] h-full">home</a>
            
            
          </div>
        
          <div class="relative group">
            <a href="" class=" text-[#d8dee9] hover:text-[#ebcb8b] h-full">posts</a>
            
            
 
              <div class="absolute  left-0 hidden p-4 mt-0 space-y-2 bg-gray-700  group-hover:block rounded-md bg-opacity-10 backdrop-blur-lg">
                
                  <div>
                    <a href="/routing/bgp/" class="text-[#d8dee9] hover:text-[#ebcb8b]">bgp</a>
                  </div>
                
                  <div>
                    <a href="/routing/ospf/" class="text-[#d8dee9] hover:text-[#ebcb8b]">o.s.p.f</a>
                  </div>
                
              </div>
            
          </div>
        
          <div class="relative group">
            <a href="" class=" text-[#d8dee9] hover:text-[#ebcb8b] h-full">projects</a>
            
            
          </div>
        
      </div>
  
      
      <div class="lg:hidden">
        <button id="hamburger" class="block text-[#5e81ac] focus:outline-none">
          <div class="w-6 h-0.5 bg-white mb-1 transition-all duration-300" id="bar1"></div>
          <div class="w-6 h-0.5 bg-white mb-1 transition-all duration-300" id="bar2"></div>
          <div class="w-6 h-0.5 bg-white transition-all duration-300" id="bar3"></div>
        </button>
      </div>
    </div>
  
    
    <div id="mobileMenu" class="lg:hidden hidden bg-gray-800">
      <div class="p-4">
        
          <div class="relative group">
            <a href="/" class="block py-2 px-4 text-[#5e81ac] hover:bg-gray-700 rounded">home</a>
  
            
          </div>
        
          <div class="relative group">
            <a href="" class="block py-2 px-4 text-[#5e81ac] hover:bg-gray-700 rounded">posts</a>
  
            
              <div class="hidden mt-2 space-y-2 bg-gray-700 p-4 group-hover:block">
                
                  <div>
                    <a href="/routing/bgp/" class="block py-2 px-4 text-[#5e81ac] hover:bg-gray-600 rounded">bgp</a>
                  </div>
                
                  <div>
                    <a href="/routing/ospf/" class="block py-2 px-4 text-[#5e81ac] hover:bg-gray-600 rounded">o.s.p.f</a>
                  </div>
                
              </div>
            
          </div>
        
          <div class="relative group">
            <a href="" class="block py-2 px-4 text-[#5e81ac] hover:bg-gray-700 rounded">projects</a>
  
            
          </div>
        
      </div>
    </div>
  </nav>

</div>



  
  
  <script>
    const hamburger = document.getElementById("hamburger");
    const bars = [document.getElementById("bar1"), document.getElementById("bar2"), document.getElementById("bar3")];
    const mobileMenu = document.getElementById("mobileMenu");
  
    hamburger.addEventListener("click", () => {
      
      mobileMenu.classList.toggle("hidden");
  
      
      bars[0].classList.toggle("rotate-45", mobileMenu.classList.contains("hidden"));
      bars[1].classList.toggle("opacity-0", mobileMenu.classList.contains("hidden"));
      bars[2].classList.toggle("rotate-135", mobileMenu.classList.contains("hidden"));
    });
  </script>
  
  
  </header>
  <div class="relative flex flex-col grow">
    <main class="grow">
      <article>
        <div id="hero" class="h-[150px] md:h-[200px]"></div>
        
       
        
        <header class="mt-5 max-w-prose">
          <h1 class="mt-0 text-4xl font-extrabold text-[#5e81ac] dark:text-neutral">Finite State Machine</h1>
          <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
            <div class="flex flex-row flex-wrap items-center">
              
              
              <time datetime="2024-11-22T13:14:14-05:00">November 22, 2024</time> 
              <span class="px-2 text-primary-500">.</span>
              <span>797 words</span>
              <span class="px-2 text-primary-500">.</span>
              <span>4 minutes</span>
            </div>
            <div class="flex flex-row flex-wrap items-center">
              
              


            </div>
          </div>
          
          <div class="flex author">
             
            
            <img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width="96" height="96"
            alt="ngeranio a.k.a nikos" src="/author/avatar.png" />
    
            <div class="place-self-center">
              <div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div>
              <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">ngeranio a.k.a nikos</div>
              <div class="text-2xl sm:text-lg"></div>
            </div>
          </div>
          <div class="mb-5"></div>
        </header>

        
        <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
        
        <div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8">
          <div class=" ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-[140px]">
            <div class="mt-0 overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block">
                <div class="min-w-[220px] py-2 border-dotted list-none  ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600 text-sm">
                  <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#idle-state">Idle State</a></li>
        <li><a href="#connect-state">Connect State</a></li>
        <li><a href="#active-state">Active State</a></li>
        <li><a href="#opensent">OpenSent</a></li>
        <li><a href="#openconfirm">OpenConfirm</a></li>
        <li><a href="#established">Established</a></li>
      </ul>
    </li>
  </ul>
</nav>
                </div>
            </div>
          </div>
        </div>
        
      <div class="min-w-0 min-h-0 max-w-fit">
        <div class="article-content max-w-prose mb-20 prose-h3:text-[#5e81ac]">
           
        <p>This article explains the BGP-FSM, the different states during the BGP neighbor negotiation and is based on Based on RFC 4271.  Unlike IGP, BGP does not have its own transport protocol, the BGP peering sessions are manually defined and rely on TCP. TCP eliminates the need to implement explicit update fragmentation, retransmission, acknowledgement, and sequencing.</p>
<p>BGP listens on TCP port 179 and BGP MUST maintain a separate FSM for each configured peer.</p>
<p>Each BGP peer paired in a potential connection will attempt to connect to the other, unless configured to remain in the ‘idle’ state, or configured to remain passive. Active or connecting is the side of the TCP connection sending the first TCP SYN packet. Passive or listening side is the sender of the first SYN/ACK.</p>
<p>BGP Neighbor States
Six states are involved in the BGP process three for TCP connectivity and three for BGP connectivity as defined by RFC 4271.</p>
<table>
  <thead>
      <tr>
          <th>TCP Connectivity</th>
          <th>BGP Connectivity</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Idle</td>
          <td>OpenSent</td>
      </tr>
      <tr>
          <td>Connect</td>
          <td>OpenConfirm</td>
      </tr>
      <tr>
          <td>Active</td>
          <td>Established</td>
      </tr>
  </tbody>
</table>
<p><img src="fsm-v1.png" alt="Finite State Machine"></p>
<h3 id="idle-state">Idle State</h3>
<blockquote>
<p>In this state, BGP refuses all incoming connections for the local system and no resources are allocated. In response to a ManualStart ( manually configure BGP on the local system ) event or an AutomaticStart ( restart existing session) BGP:</p>
</blockquote>
<ul>
<li>initializes all BGP resources for the peer connection,</li>
<li>sets ConncectRetryCounter to zero,</li>
<li>starts the ConnectRetryTimer with the initial value,</li>
<li>initiates the TCP connection to the other peer,</li>
<li>listens for a connection that may be initiated by the remote BGP peer and</li>
<li>changes its state to Connect.<br>
In case of errors, BGP falls back to the Idle state.</li>
</ul>
<h3 id="connect-state">Connect State</h3>
<blockquote>
<p>BGP is waiting for the transport protocol connection to be completed.</p>
</blockquote>
<p><strong>If the TCP connection succeeds.</strong></p>
<ul>
<li>stops the ConnectRetryTimer ( if running ) and sets the ConnectRetryTimer to zero,</li>
<li>completes the BGP initialization</li>
<li>sends an OPEN message to its peer,</li>
<li>sets the HoldTimer to a large value ( the suggestion is 5min), and</li>
<li>changes its state to OpenSent.</li>
</ul>
<p><strong>If the TCP connection fails</strong></p>
<ul>
<li>restarts the ConnectRetryTimer,</li>
<li>changes its state to Active.</li>
</ul>
<p><strong>If the ConnectRetry timer expires</strong></p>
<ul>
<li>remains in the Connect state</li>
<li>the timer is reset, and transport connection is initiated</li>
</ul>
<p>In case of any other event the state goes back to Idle.</p>
<h3 id="active-state">Active State</h3>
<blockquote>
<p>In this state, BGP is trying to acquire a peer by listening for, and accepting a TCP connection</p>
</blockquote>
<p><strong>If the TCP connection succeeds</strong></p>
<ul>
<li>clears the BGP ConnectRetryTimer,</li>
<li>sends an OPEN message to its peer,</li>
<li>changes its state to OpenSent.</li>
</ul>
<p><strong>If the TCP connection fails</strong></p>
<ul>
<li>resets the ConnectRetryTimer,</li>
<li>changes its state to Idle.</li>
</ul>
<p><strong>If the ConnectRetry timer expires</strong></p>
<ul>
<li>BGP restarts the ConnectRetry timer</li>
<li>falls back to the Connect.</li>
</ul>
<p>The state might go back to Idle in case of other events, such as a Stop event initiated by the system or the operator. If the state is oscillating between Connect and Active indicates that something is wrong with the TCP transport connection.</p>
<h3 id="opensent">OpenSent</h3>
<blockquote>
<p>In this state, BGP waits for an OPEN message from its peer. Once received checks all fields for correctness.</p>
</blockquote>
<p><strong>The OPEN message contains:</strong></p>
<ul>
<li>BGP version.</li>
<li>The autonomous system (AS) number.</li>
<li>The source IP address of the configured neighbor.</li>
<li>Router-ID uniqueness.</li>
<li>Security parameters ( TTL, password, etc)</li>
<li>Capabilities.</li>
</ul>
<p><strong>If there are errors or capabilities mismatch in the OPEN message the local system:</strong></p>
<ul>
<li>the system sends an error NOTIFICATION message</li>
<li>goes back to Active.</li>
</ul>
<p><strong>If there is an error due to TCP event</strong></p>
<ul>
<li>the state will change to Active</li>
<li>will attempt to complete the three-way handshake.</li>
</ul>
<p><strong>If there are no errors in the OPEN message the local system:</strong></p>
<ul>
<li>resets the DelayOpenTimer to zero,</li>
<li>sets ConnectRetryTimer to zero,</li>
<li>sends a KEEPALIVE message, and</li>
<li>sets the HoldTimer per the negotiated value, and</li>
<li>changes its state to OpenConfirm.</li>
</ul>
<h3 id="openconfirm">OpenConfirm</h3>
<blockquote>
<p>In this state, BGP waits for a KEEPALIVE or NOTIFICATION message.</p>
</blockquote>
<p><strong>If a NOTIFICATION message is received,</strong></p>
<ul>
<li>falls back to the Idle state</li>
</ul>
<p><strong>In case of any transport disconnect notification or in response to any stop event</strong></p>
<ul>
<li>the state falls back to Idle state</li>
</ul>
<p><strong>If the local system receives a KEPALIVE the local system:</strong></p>
<ul>
<li>restarts the HoldTimer and</li>
<li>changes its state to Established.<br>
The system sends periodic KEEPALIVE messages at the rate set by the KEEPALIVE timer.</li>
</ul>
<h3 id="established">Established</h3>
<blockquote>
<p>In the Established state, BGP can exchange UPDATE, NOTIFICATION and KEEPALIVE messages with its peer.</p>
</blockquote>
<p>If the HoldTimer expires before the local system receives a KEPALIVE, NOTIFICATION or an UPADTE message BGP will change its state to Idle.</p>
<p>The UPDATE messages are checked for errors or missing attributes such as missing attributes. If errors are found, a NOTIFICATION message is sent to the peer, and the state falls back to Idle.</p>
<p>If the Hold Timer expires, or a disconnect notification is received from the transport protocol, or a Stop event is received, or in response to any other event, the system falls back to the Idle state.</p>

         
        </div>
        
        <div class="flex justify-between">
  
  <div class="">
    
  </div>
  
  <div class="">
    
    <a
      href="http://localhost:1313/routing/bgp/bgp-route-selection/?ref=footer"
      class="flex items-center justify-center px-3 h-8 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white"
    >
      Next
      <svg
        class="w-3.5 h-3.5 ms-2 rtl:rotate-180"
        aria-hidden="true"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 14 10"
      >
        <path
          stroke="currentColor"
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M1 5h12m0 0L9 1m4 4L9 9"
        />
      </svg>
    </a>
    
  </div>
</div>

      
      </div>
        </section>
      </article>
  
      </main>
  </div>
  <footer>
    <footer class="mx-auto w-full  max-w-container text-center" >
    
   <div class="max-w-screen-xl sm:pt-5 md:pt-8 pt-0">
       <div class="border-b border-[#4c566a] mb-5 flex justify-between"></div>
   </div> 
   <div class="flex flex-col items-center ">
       
       <div id="logo">
           <span class="text-[#5e81ac]">ngeran[</span><span class="text-[#ebcb8b]">io</span><span class="text-[#5e81ac]">]</span>
       </div>
       <p class="mt-5 text-center text-sm leading-6 text-slate-500">© Copyright 2024. All rights reserved.</p>
       <div class="mt-4 flex items-center justify-center space-x-4 text-sm font-semibold leading-6 text-slate-700"><a href="/privacy-policy">Privacy policy</a>
           <div class="h-4 w-px bg-slate-500/20"></div><a href="/changelog">Changelog</a>
       </div>
   </div>
</footer>
  </footer>
</body>
</html>

